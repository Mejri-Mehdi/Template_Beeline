{% extends 'base.html.twig' %}

{% block title %}Modifier une Offre{% endblock %}
{% block page_title %}Modifier Offre{% endblock %}
{% block breadcrumb %}<a href="{{ path('app_dashboard') }}">Dashboard</a> / <a href="{{ path('app_offre_index') }}">Offres</a> / <span class="active">Modifier</span>{% endblock %}

{% block body %}
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-edit me-2"></i>Modifier l'offre</h3>
            <div class="d-flex gap-2">
                <a href="{{ path('app_offre_index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Retour
                </a>
                <a href="{{ path('app_offre_show', {'id': offre.id}) }}" class="btn btn-outline-info">
                    <i class="fas fa-eye me-2"></i> Voir détails
                </a>
            </div>
        </div>
        
        <form id="offreEditForm" class="mt-4">
            <input type="hidden" id="id" value="{{ offre.id }}">
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Référence:</strong> #OFF-{{ "%03d"|format(offre.id) }}
                <span class="ms-3"><strong>Statut actuel:</strong> {{ offre.statut }}</span>
            </div>
            
            <!-- Informations de base -->
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group mb-4">
                        <label for="nom" class="form-label fw-bold">
                            <i class="fas fa-heading me-2"></i>Nom de l'offre *
                        </label>
                        <input type="text" class="form-control" id="nom" required 
                               value="{{ offre.nom }}">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group mb-4">
                        <label for="reference" class="form-label fw-bold">
                            <i class="fas fa-hashtag me-2"></i>Référence
                        </label>
                        <input type="text" class="form-control" id="reference" 
                               value="#OFF-{{ "%03d"|format(offre.id) }}" readonly>
                    </div>
                </div>
            </div>
            
            <div class="form-group mb-4">
                <label for="description" class="form-label fw-bold">
                    <i class="fas fa-align-left me-2"></i>Description détaillée *
                </label>
                <textarea class="form-control" id="description" rows="4" required>{{ offre.description }}</textarea>
            </div>
            
            <!-- Configuration -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-4">
                        <label for="type_offre" class="form-label fw-bold">
                            <i class="fas fa-tag me-2"></i>Type d'offre *
                        </label>
                        <select class="form-select" id="type_offre" required>
                            <option value="taux_reduit" {{ offre.type_offre == 'taux_reduit' ? 'selected' : '' }}>Taux Réduit</option>
                            <option value="promotion_speciale" {{ offre.type_offre == 'promotion_speciale' ? 'selected' : '' }}>Promotion Spéciale</option>
                            <option value="nouveau_client" {{ offre.type_offre == 'nouveau_client' ? 'selected' : '' }}>Nouveau Client</option>
                            <option value="fidelite" {{ offre.type_offre == 'fidelite' ? 'selected' : '' }}>Fidélité</option>
                            <option value="saisonnier" {{ offre.type_offre == 'saisonnier' ? 'selected' : '' }}>Saisonnier</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group mb-4">
                        <label for="banque_id" class="form-label fw-bold">
                            <i class="fas fa-university me-2"></i>Banque *
                        </label>
                        <select class="form-select" id="banque_id" required>
                            <option value="1" {{ offre.banque_id == 1 ? 'selected' : '' }}>Banque Zitouna</option>
                            <option value="2" {{ offre.banque_id == 2 ? 'selected' : '' }}>Amen Bank</option>
                            <option value="3" {{ offre.banque_id == 3 ? 'selected' : '' }}>BIAT</option>
                            <option value="4" {{ offre.banque_id == 4 ? 'selected' : '' }}>UBCI</option>
                            <option value="5" {{ offre.banque_id == 5 ? 'selected' : '' }}>ATB</option>
                            <option value="6" {{ offre.banque_id == 6 ? 'selected' : '' }}>Banque de Tunisie</option>
                            <option value="7" {{ offre.banque_id == 7 ? 'selected' : '' }}>Wifak Bank</option>
                            <option value="8" {{ offre.banque_id == 8 ? 'selected' : '' }}>Banque Nationale Agricole</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group mb-4">
                        <label for="statut" class="form-label fw-bold">
                            <i class="fas fa-toggle-on me-2"></i>Statut *
                        </label>
                        <select class="form-select" id="statut" required>
                            <option value="active" {{ offre.statut == 'active' ? 'selected' : '' }}>Active</option>
                            <option value="inactive" {{ offre.statut == 'inactive' ? 'selected' : '' }}>Inactive</option>
                            <option value="expired" {{ offre.statut == 'expired' ? 'selected' : '' }}>Expirée</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Dates -->
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group mb-4">
                        <label for="date_debut" class="form-label fw-bold">
                            <i class="fas fa-calendar-plus me-2"></i>Date début *
                        </label>
                        <input type="date" class="form-control" id="date_debut" required 
                               value="{{ offre.date_debut }}">
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group mb-4">
                        <label for="date_fin" class="form-label fw-bold">
                            <i class="fas fa-calendar-minus me-2"></i>Date fin *
                        </label>
                        <input type="date" class="form-control" id="date_fin" required 
                               value="{{ offre.date_fin }}">
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group mb-4">
                        <label for="taux_interet" class="form-label fw-bold">
                            <i class="fas fa-percentage me-2"></i>Taux d'intérêt *
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="taux_interet" required 
                                   value="{{ offre.taux_interet|replace({'%': ''}) }}">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group mb-4">
                        <label for="duree_max" class="form-label fw-bold">
                            <i class="fas fa-clock me-2"></i>Durée max *
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="duree_max" required 
                                   value="{{ offre.duree_max|replace({' mois': ''}) }}">
                            <span class="input-group-text">mois</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Conditions -->
            <div class="form-group mb-4">
                <label for="conditions" class="form-label fw-bold">
                    <i class="fas fa-clipboard-list me-2"></i>Conditions d'éligibilité *
                </label>
                <textarea class="form-control" id="conditions" rows="4" required>{{ offre.conditions }}</textarea>
            </div>
            
            <!-- Montants -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-4">
                        <label for="montant_min" class="form-label fw-bold">
                            <i class="fas fa-money-bill-wave me-2"></i>Montant minimum *
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="montant_min" required 
                                   value="{{ offre.montant_min }}">
                            <span class="input-group-text">TND</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group mb-4">
                        <label for="montant_max" class="form-label fw-bold">
                            <i class="fas fa-money-bill-wave me-2"></i>Montant maximum *
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="montant_max" required 
                                   value="{{ offre.montant_max }}">
                            <span class="input-group-text">TND</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Documents requis -->
            <div class="form-group mb-4">
                <label class="form-label fw-bold">
                    <i class="fas fa-file-alt me-2"></i>Documents requis *
                </label>
                <div class="documents-list">
                    {% set documents_checked = {
                        'cin': 'Carte d\'identité nationale' in offre.documents_requis,
                        'justif_domicile': 'Justificatif de domicile' in offre.documents_requis,
                        'fiches_paie': '3 dernières fiches de paie' in offre.documents_requis,
                        'contrat_travail': 'Contrat de travail' in offre.documents_requis,
                        'rib': 'Relevé d\'identité bancaire' in offre.documents_requis
                    } %}
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_cin" {{ documents_checked.cin ? 'checked' : '' }} required>
                        <label class="form-check-label" for="doc_cin">
                            Carte d'identité nationale
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_justif_domicile" {{ documents_checked.justif_domicile ? 'checked' : '' }} required>
                        <label class="form-check-label" for="doc_justif_domicile">
                            Justificatif de domicile
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_fiches_paie" {{ documents_checked.fiches_paie ? 'checked' : '' }} required>
                        <label class="form-check-label" for="doc_fiches_paie">
                            3 dernières fiches de paie
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_contrat_travail" {{ documents_checked.contrat_travail ? 'checked' : '' }}>
                        <label class="form-check-label" for="doc_contrat_travail">
                            Contrat de travail
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_rib" {{ documents_checked.rib ? 'checked' : '' }} required>
                        <label class="form-check-label" for="doc_rib">
                            Relevé d'identité bancaire
                        </label>
                    </div>
                    <div class="form-text mt-2">Cocher au moins 3 documents requis</div>
                </div>
            </div>
            
            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="terms" required checked>
                <label class="form-check-label" for="terms">
                    Je certifie que les informations fournies sont exactes.
                </label>
            </div>
            
            <hr class="my-4">
            
            <div class="d-flex justify-content-between">
                <a href="{{ path('app_offre_index') }}" class="btn btn-outline-secondary px-5">
                    <i class="fas fa-times me-2"></i> Annuler
                </a>
                <button type="submit" class="btn btn-success px-5">
                    <i class="fas fa-save me-2"></i> Enregistrer
                </button>
            </div>
        </form>
    </div>
    
    <script>
        // Validation des dates
        document.getElementById('date_debut').addEventListener('change', function() {
            const finInput = document.getElementById('date_fin');
            if (this.value && finInput.value && this.value > finInput.value) {
                alert('La date de début doit être antérieure à la date de fin');
                this.value = '';
            }
        });
        
        document.getElementById('date_fin').addEventListener('change', function() {
            const debutInput = document.getElementById('date_debut');
            if (this.value && debutInput.value && this.value < debutInput.value) {
                alert('La date de fin doit être postérieure à la date de début');
                this.value = '';
            }
        });
        
        // Validation des montants
        document.getElementById('montant_max').addEventListener('blur', function() {
            const min = parseFloat(document.getElementById('montant_min').value.replace(/\s/g, '')) || 0;
            const max = parseFloat(this.value.replace(/\s/g, '')) || 0;
            
            if (min > max) {
                alert('Le montant maximum doit être supérieur au montant minimum');
                this.value = '';
            }
        });
        
        // Validation des documents (au moins 3)
        function validerDocuments() {
            const documents = [
                document.getElementById('doc_cin'),
                document.getElementById('doc_justif_domicile'),
                document.getElementById('doc_fiches_paie'),
                document.getElementById('doc_contrat_travail'),
                document.getElementById('doc_rib')
            ];
            
            const documentsCoches = documents.filter(doc => doc.checked).length;
            return documentsCoches >= 3;
        }
        
        // Soumission du formulaire
        document.getElementById('offreEditForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validation des champs obligatoires
            const requiredFields = ['nom', 'description', 'type_offre', 'banque_id', 
                                   'date_debut', 'date_fin', 'taux_interet', 'conditions',
                                   'montant_min', 'montant_max', 'duree_max'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            // Validation des documents
            if (!validerDocuments()) {
                alert('Veuillez sélectionner au moins 3 documents requis');
                return;
            }
            
            if (!document.getElementById('terms').checked) {
                alert('Veuillez accepter les conditions');
                return;
            }
            
            // Collecter les données
            const offreData = {
                id: document.getElementById('id').value,
                nom: document.getElementById('nom').value,
                type_offre: document.getElementById('type_offre').value,
                banque_id: document.getElementById('banque_id').value,
                date_debut: document.getElementById('date_debut').value,
                date_fin: document.getElementById('date_fin').value,
                taux_interet: document.getElementById('taux_interet').value + '%',
                conditions: document.getElementById('conditions').value,
                montant_min: document.getElementById('montant_min').value,
                montant_max: document.getElementById('montant_max').value,
                duree_max: document.getElementById('duree_max').value + ' mois',
                statut: document.getElementById('statut').value,
                documents: {
                    cin: document.getElementById('doc_cin').checked,
                    justif_domicile: document.getElementById('doc_justif_domicile').checked,
                    fiches_paie: document.getElementById('doc_fiches_paie').checked,
                    contrat_travail: document.getElementById('doc_contrat_travail').checked,
                    rib: document.getElementById('doc_rib').checked
                }
            };
            
            // Simulation de modification
            console.log('Offre modifiée:', offreData);
            alert('Offre modifiée avec succès! (Simulation)');
            
            // Redirection
            setTimeout(() => {
                window.location.href = "{{ path('app_offre_index') }}";
            }, 1000);
        });
    </script>
    
    <style>
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .documents-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .form-check {
            padding-left: 1.5em;
        }
        
        .form-check-input {
            width: 1.2em;
            height: 1.2em;
            margin-top: 0.2em;
            margin-left: -1.5em;
        }
        
        .form-check-label {
            font-weight: 500;
            color: #495057;
        }
        
        .is-invalid {
            border-color: #dc3545;
        }
        
        .input-group-text {
            background-color: #f8f9fa;
            color: #495057;
        }
        
        .alert {
            background: #e0e7ff;
            border-color: #c7d2fe;
            color: #3730a3;
        }
    </style>
{% endblock %}
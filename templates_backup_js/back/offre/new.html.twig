{% extends 'base.html.twig' %}

{% block title %}Ajouter une Offre Bancaire{% endblock %}
{% block page_title %}Nouvelle Offre{% endblock %}
{% block breadcrumb %}<a href="{{ path('app_dashboard') }}">Dashboard</a> / <a href="{{ path('app_offre_index') }}">Offres</a> / <span class="active">Nouvelle</span>{% endblock %}

{% block body %}
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-plus-circle me-2"></i>Créer une nouvelle offre</h3>
            <a href="{{ path('app_offre_index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i> Retour
            </a>
        </div>
        
        <form id="offreForm" class="mt-4">
            <!-- Informations de base -->
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group mb-4">
                        <label for="nom" class="form-label fw-bold">
                            <i class="fas fa-heading me-2"></i>Nom de l'offre *
                        </label>
                        <input type="text" class="form-control" id="nom" required 
                               placeholder="Ex: Crédit Immobilier - Taux Exceptionnel">
                        <div class="form-text">Titre attractif et descriptif pour l'offre</div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group mb-4">
                        <label for="reference" class="form-label fw-bold">
                            <i class="fas fa-hashtag me-2"></i>Référence
                        </label>
                        <input type="text" class="form-control" id="reference" 
                               placeholder="OFF-XXXX" value="OFF-{{ "now"|date("ymd") }}">
                        <div class="form-text">Généré automatiquement</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group mb-4">
                <label for="description" class="form-label fw-bold">
                    <i class="fas fa-align-left me-2"></i>Description détaillée *
                </label>
                <textarea class="form-control" id="description" rows="4" required 
                          placeholder="Décrivez l'offre en détail, ses avantages, ses caractéristiques..."></textarea>
            </div>
            
            <!-- Configuration -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-4">
                        <label for="type_offre" class="form-label fw-bold">
                            <i class="fas fa-tag me-2"></i>Type d'offre *
                        </label>
                        <select class="form-select" id="type_offre" required>
                            <option value="">Sélectionner un type</option>
                            <option value="taux_reduit">Taux Réduit</option>
                            <option value="promotion_speciale">Promotion Spéciale</option>
                            <option value="nouveau_client">Nouveau Client</option>
                            <option value="fidelite">Fidélité</option>
                            <option value="saisonnier">Saisonnier</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group mb-4">
                        <label for="banque_id" class="form-label fw-bold">
                            <i class="fas fa-university me-2"></i>Banque *
                        </label>
                        <select class="form-select" id="banque_id" required>
                            <option value="">Sélectionner une banque</option>
                            <option value="1">Banque Zitouna</option>
                            <option value="2">Amen Bank</option>
                            <option value="3">BIAT</option>
                            <option value="4">UBCI</option>
                            <option value="5">ATB</option>
                            <option value="6">Banque de Tunisie</option>
                            <option value="7">Wifak Bank</option>
                            <option value="8">Banque Nationale Agricole</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Dates -->
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group mb-4">
                        <label for="date_debut" class="form-label fw-bold">
                            <i class="fas fa-calendar-plus me-2"></i>Date début *
                        </label>
                        <input type="date" class="form-control" id="date_debut" required>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group mb-4">
                        <label for="date_fin" class="form-label fw-bold">
                            <i class="fas fa-calendar-minus me-2"></i>Date fin *
                        </label>
                        <input type="date" class="form-control" id="date_fin" required>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group mb-4">
                        <label for="taux_interet" class="form-label fw-bold">
                            <i class="fas fa-percentage me-2"></i>Taux d'intérêt *
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="taux_interet" required 
                                   placeholder="3.5">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group mb-4">
                        <label for="duree_max" class="form-label fw-bold">
                            <i class="fas fa-clock me-2"></i>Durée max *
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="duree_max" required 
                                   placeholder="240">
                            <span class="input-group-text">mois</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Conditions -->
            <div class="form-group mb-4">
                <label for="conditions" class="form-label fw-bold">
                    <i class="fas fa-clipboard-list me-2"></i>Conditions d'éligibilité *
                </label>
                <textarea class="form-control" id="conditions" rows="4" required 
                          placeholder="Listez les conditions pour bénéficier de cette offre...
• Client doit avoir plus de 18 ans
• Revenu minimum: 1500 TND/mois
• Premier crédit uniquement
• ..."></textarea>
                <div class="form-text">Utilisez des puces (•) pour une meilleure lisibilité</div>
            </div>
            
            <!-- Montants -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-4">
                        <label for="montant_min" class="form-label fw-bold">
                            <i class="fas fa-money-bill-wave me-2"></i>Montant minimum *
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="montant_min" required 
                                   placeholder="50000">
                            <span class="input-group-text">TND</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group mb-4">
                        <label for="montant_max" class="form-label fw-bold">
                            <i class="fas fa-money-bill-wave me-2"></i>Montant maximum *
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="montant_max" required 
                                   placeholder="500000">
                            <span class="input-group-text">TND</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Documents requis -->
            <div class="form-group mb-4">
                <label class="form-label fw-bold">
                    <i class="fas fa-file-alt me-2"></i>Documents requis *
                </label>
                <div class="documents-list">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_cin" required>
                        <label class="form-check-label" for="doc_cin">
                            Carte d'identité nationale
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_justif_domicile" required>
                        <label class="form-check-label" for="doc_justif_domicile">
                            Justificatif de domicile
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_fiches_paie" required>
                        <label class="form-check-label" for="doc_fiches_paie">
                            3 dernières fiches de paie
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_contrat_travail">
                        <label class="form-check-label" for="doc_contrat_travail">
                            Contrat de travail
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="doc_rib" required>
                        <label class="form-check-label" for="doc_rib">
                            Relevé d'identité bancaire
                        </label>
                    </div>
                    <div class="form-text mt-2">Cocher au moins 3 documents requis</div>
                </div>
            </div>
            
            <!-- Validation -->
            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="terms" required>
                <label class="form-check-label" for="terms">
                    Je certifie que les informations fournies sont exactes et que je suis autorisé à créer cette offre.
                </label>
            </div>
            
            <div class="d-flex justify-content-between pt-4 border-top">
                <a href="{{ path('app_offre_index') }}" class="btn btn-outline-secondary px-5">
                    <i class="fas fa-times me-2"></i> Annuler
                </a>
                <button type="submit" class="btn btn-primary px-5">
                    <i class="fas fa-plus me-2"></i> Créer l'offre
                </button>
            </div>
        </form>
    </div>
    
    <script>
        // Validation des dates
        document.getElementById('date_debut').addEventListener('change', function() {
            const finInput = document.getElementById('date_fin');
            if (this.value && finInput.value && this.value > finInput.value) {
                alert('La date de début doit être antérieure à la date de fin');
                this.value = '';
            }
        });
        
        document.getElementById('date_fin').addEventListener('change', function() {
            const debutInput = document.getElementById('date_debut');
            if (this.value && debutInput.value && this.value < debutInput.value) {
                alert('La date de fin doit être postérieure à la date de début');
                this.value = '';
            }
        });
        
        // Validation des montants
        document.getElementById('montant_max').addEventListener('blur', function() {
            const min = parseFloat(document.getElementById('montant_min').value.replace(/\s/g, '')) || 0;
            const max = parseFloat(this.value.replace(/\s/g, '')) || 0;
            
            if (min > max) {
                alert('Le montant maximum doit être supérieur au montant minimum');
                this.value = '';
            }
        });
        
        // Validation des documents (au moins 3)
        function validerDocuments() {
            const documents = [
                document.getElementById('doc_cin'),
                document.getElementById('doc_justif_domicile'),
                document.getElementById('doc_fiches_paie'),
                document.getElementById('doc_contrat_travail'),
                document.getElementById('doc_rib')
            ];
            
            const documentsCoches = documents.filter(doc => doc.checked).length;
            return documentsCoches >= 3;
        }
        
        // Soumission du formulaire
        document.getElementById('offreForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validation des champs obligatoires
            const requiredFields = ['nom', 'description', 'type_offre', 'banque_id', 
                                   'date_debut', 'date_fin', 'taux_interet', 'conditions',
                                   'montant_min', 'montant_max', 'duree_max'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }
            
            // Validation des documents
            if (!validerDocuments()) {
                alert('Veuillez sélectionner au moins 3 documents requis');
                return;
            }
            
            if (!document.getElementById('terms').checked) {
                alert('Veuillez accepter les conditions');
                return;
            }
            
            // Collecter les données
            const offreData = {
                nom: document.getElementById('nom').value,
                reference: document.getElementById('reference').value,
                description: document.getElementById('description').value,
                type_offre: document.getElementById('type_offre').value,
                banque_id: document.getElementById('banque_id').value,
                date_debut: document.getElementById('date_debut').value,
                date_fin: document.getElementById('date_fin').value,
                taux_interet: document.getElementById('taux_interet').value,
                conditions: document.getElementById('conditions').value,
                montant_min: document.getElementById('montant_min').value,
                montant_max: document.getElementById('montant_max').value,
                duree_max: document.getElementById('duree_max').value,
                documents: {
                    cin: document.getElementById('doc_cin').checked,
                    justif_domicile: document.getElementById('doc_justif_domicile').checked,
                    fiches_paie: document.getElementById('doc_fiches_paie').checked,
                    contrat_travail: document.getElementById('doc_contrat_travail').checked,
                    rib: document.getElementById('doc_rib').checked
                }
            };
            
            // Simulation de création
            console.log('Offre à créer:', offreData);
            alert('Offre créée avec succès! (Simulation)');
            
            // Redirection
            setTimeout(() => {
                window.location.href = "{{ path('app_offre_index') }}";
            }, 1000);
        });
    </script>
    
    <style>
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .documents-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .form-check {
            padding-left: 1.5em;
        }
        
        .form-check-input {
            width: 1.2em;
            height: 1.2em;
            margin-top: 0.2em;
            margin-left: -1.5em;
        }
        
        .form-check-label {
            font-weight: 500;
            color: #495057;
        }
        
        .is-invalid {
            border-color: #dc3545;
        }
        
        .input-group-text {
            background-color: #f8f9fa;
            color: #495057;
        }
    </style>
{% endblock %}